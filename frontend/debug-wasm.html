<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WASM Debug - StarsCalendars</title>
    <style>
        body {
            font-family: 'Consolas', 'Monaco', monospace;
            background: #0a0a0a;
            color: #00ff00;
            padding: 20px;
            line-height: 1.6;
        }
        .debug-section {
            background: #1a1a1a;
            border: 1px solid #333;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success { color: #00ff00; }
        .error { color: #ff4444; }
        .warning { color: #ffaa00; }
        .info { color: #4488cc; }
        pre {
            background: #000;
            padding: 10px;
            border-left: 3px solid #00ff00;
            overflow-x: auto;
        }
        button {
            background: #2a2a2a;
            color: #00ff00;
            border: 1px solid #555;
            padding: 10px 20px;
            cursor: pointer;
            margin: 5px;
            border-radius: 3px;
        }
        button:hover {
            background: #3a3a3a;
        }
    </style>
</head>
<body>
    <h1>üåå WASM Astronomical Module Debug Console</h1>
    
    <div class="debug-section">
        <h2>üìã Module Status</h2>
        <div id="module-status">Loading...</div>
    </div>

    <div class="debug-section">
        <h2>üß™ Function Tests</h2>
        <button onclick="testWasmFunctions()">Test All Functions</button>
        <button onclick="testCalculation()">Test Single Calculation</button>
        <button onclick="testMemoryAccess()">Test Memory Access</button>
        <div id="test-results"></div>
    </div>

    <div class="debug-section">
        <h2>üìä Real-time Data</h2>
        <button onclick="startRealtimeTest()" id="realtime-btn">Start Real-time Test</button>
        <div id="realtime-data"></div>
    </div>

    <div class="debug-section">
        <h2>üìù Debug Log</h2>
        <div id="debug-log"></div>
    </div>

    <script type="module">
        let wasmModule = null;
        let realtimeInterval = null;

        // Debug logging function
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('debug-log');
            const entry = document.createElement('div');
            entry.className = type;
            entry.innerHTML = `[${timestamp}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        // Initialize WASM module
        async function initWasm() {
            try {
                log('üöÄ Loading WASM module...', 'info');
                
                // Import the WASM module
                const wasmImport = await import('./src/wasm-astro/starscalendars_wasm_astro.js');
                log('‚úÖ WASM JavaScript wrapper loaded', 'success');
                
                // Initialize WASM
                const initOutput = await wasmImport.default();
                log('‚úÖ WASM module initialized', 'success');
                
                // Test basic functions
                const bodyCount = initOutput.get_body_count();
                const coordCount = initOutput.get_coordinate_count();
                const version = initOutput.get_version();
                
                log(`üìä Body count: ${bodyCount}`, 'info');
                log(`üìä Coordinate count: ${coordCount}`, 'info');
                log(`üìä Version: ${version}`, 'info');
                log(`üìä Memory buffer size: ${initOutput.memory.buffer.byteLength} bytes`, 'info');
                
                wasmModule = initOutput;
                updateModuleStatus();
                
                // Test a single calculation
                const testJD = 2451545.0; // J2000 epoch
                const ptr = wasmModule.compute_all(testJD);
                log(`üß™ Test calculation result: pointer = ${ptr}`, ptr !== 0 ? 'success' : 'error');
                
                if (ptr !== 0) {
                    // Test memory access
                    const positions = new Float64Array(wasmModule.memory.buffer, ptr, coordCount);
                    log(`üìä First few coordinates: [${positions.slice(0, 6).map(v => v.toFixed(6)).join(', ')}]`, 'info');
                }
                
                return true;
            } catch (error) {
                log(`‚ùå WASM initialization failed: ${error.message}`, 'error');
                log(`üìã Error details: ${error.stack}`, 'error');
                return false;
            }
        }

        // Update module status display
        function updateModuleStatus() {
            const statusDiv = document.getElementById('module-status');
            if (wasmModule) {
                statusDiv.innerHTML = `
                    <div class="success">‚úÖ WASM Module Loaded</div>
                    <div>Bodies: ${wasmModule.get_body_count()}</div>
                    <div>Coordinates: ${wasmModule.get_coordinate_count()}</div>
                    <div>Version: ${wasmModule.get_version()}</div>
                    <div>Memory: ${wasmModule.memory.buffer.byteLength} bytes</div>
                `;
            } else {
                statusDiv.innerHTML = '<div class="error">‚ùå WASM Module Not Loaded</div>';
            }
        }

        // Test all WASM functions
        window.testWasmFunctions = function() {
            const resultsDiv = document.getElementById('test-results');
            if (!wasmModule) {
                resultsDiv.innerHTML = '<div class="error">‚ùå WASM module not loaded</div>';
                return;
            }

            let results = '<h3>Function Test Results:</h3>';
            
            try {
                // Test basic info functions
                const bodyCount = wasmModule.get_body_count();
                const coordCount = wasmModule.get_coordinate_count();
                const version = wasmModule.get_version();
                
                results += `<div class="success">‚úÖ get_body_count(): ${bodyCount}</div>`;
                results += `<div class="success">‚úÖ get_coordinate_count(): ${coordCount}</div>`;  
                results += `<div class="success">‚úÖ get_version(): ${version}</div>`;
                
                // Test calculation with different Julian Days
                const testDates = [
                    { name: 'J2000 Epoch', jd: 2451545.0 },
                    { name: 'Now', jd: 2440587.5 + Date.now() / 86400000.0 },
                    { name: 'Future', jd: 2451545.0 + 365.25 * 10 } // 10 years from J2000
                ];
                
                for (const testDate of testDates) {
                    const ptr = wasmModule.compute_all(testDate.jd);
                    if (ptr !== 0) {
                        const positions = new Float64Array(wasmModule.memory.buffer, ptr, coordCount);
                        const sunDist = Math.sqrt(positions[0]**2 + positions[1]**2 + positions[2]**2);
                        const moonDist = Math.sqrt(positions[3]**2 + positions[4]**2 + positions[5]**2);
                        results += `<div class="success">‚úÖ ${testDate.name} (JD: ${testDate.jd.toFixed(1)})</div>`;
                        results += `<div class="info">   Sun distance: ${sunDist.toFixed(6)} AU</div>`;
                        results += `<div class="info">   Moon distance: ${moonDist.toFixed(6)} AU</div>`;
                    } else {
                        results += `<div class="error">‚ùå ${testDate.name} - calculation failed</div>`;
                    }
                }
                
            } catch (error) {
                results += `<div class="error">‚ùå Test failed: ${error.message}</div>`;
            }
            
            resultsDiv.innerHTML = results;
        };

        // Test single calculation with detailed output
        window.testCalculation = function() {
            const resultsDiv = document.getElementById('test-results');
            if (!wasmModule) {
                resultsDiv.innerHTML = '<div class="error">‚ùå WASM module not loaded</div>';
                return;
            }

            const jd = 2440587.5 + Date.now() / 86400000.0; // Current Julian Day
            log(`üß™ Testing calculation for JD: ${jd.toFixed(6)}`, 'info');
            
            const ptr = wasmModule.compute_all(jd);
            log(`üìä Returned pointer: ${ptr}`, ptr !== 0 ? 'success' : 'error');
            
            if (ptr !== 0) {
                const coordCount = wasmModule.get_coordinate_count();
                const positions = new Float64Array(wasmModule.memory.buffer, ptr, coordCount);
                
                const bodyNames = ['Sun', 'Moon', 'Mercury', 'Venus', 'Earth', 'Mars', 'Jupiter', 'Saturn', 'Uranus', 'Neptune', 'Pluto'];
                let output = '<h3>Current Celestial Positions:</h3><pre>';
                
                for (let i = 0; i < 11; i++) {
                    const x = positions[i * 3];
                    const y = positions[i * 3 + 1];
                    const z = positions[i * 3 + 2];
                    const dist = Math.sqrt(x*x + y*y + z*z);
                    output += `${bodyNames[i].padEnd(8)}: [${x.toFixed(6)}, ${y.toFixed(6)}, ${z.toFixed(6)}] (${dist.toFixed(6)} AU)\\n`;
                }
                
                output += '</pre>';
                resultsDiv.innerHTML = output;
            } else {
                resultsDiv.innerHTML = '<div class="error">‚ùå Calculation returned null pointer</div>';
            }
        };

        // Test memory access patterns
        window.testMemoryAccess = function() {
            const resultsDiv = document.getElementById('test-results');
            if (!wasmModule) {
                resultsDiv.innerHTML = '<div class="error">‚ùå WASM module not loaded</div>';
                return;
            }

            let results = '<h3>Memory Access Test:</h3>';
            
            // Test multiple rapid calculations
            const start = performance.now();
            let successCount = 0;
            const testCount = 100;
            
            for (let i = 0; i < testCount; i++) {
                const jd = 2451545.0 + i; // Different Julian Days
                const ptr = wasmModule.compute_all(jd);
                if (ptr !== 0) {
                    successCount++;
                }
            }
            
            const duration = performance.now() - start;
            results += `<div class="success">‚úÖ ${successCount}/${testCount} calculations successful</div>`;
            results += `<div class="info">üìä Average time: ${(duration / testCount).toFixed(3)}ms per calculation</div>`;
            results += `<div class="info">üìä Total time: ${duration.toFixed(3)}ms</div>`;
            
            resultsDiv.innerHTML = results;
        };

        // Start real-time testing
        window.startRealtimeTest = function() {
            const btn = document.getElementById('realtime-btn');
            const dataDiv = document.getElementById('realtime-data');
            
            if (realtimeInterval) {
                clearInterval(realtimeInterval);
                realtimeInterval = null;
                btn.textContent = 'Start Real-time Test';
                return;
            }
            
            if (!wasmModule) {
                dataDiv.innerHTML = '<div class="error">‚ùå WASM module not loaded</div>';
                return;
            }
            
            btn.textContent = 'Stop Real-time Test';
            let frameCount = 0;
            let totalTime = 0;
            
            realtimeInterval = setInterval(() => {
                const start = performance.now();
                const jd = 2440587.5 + Date.now() / 86400000.0;
                const ptr = wasmModule.compute_all(jd);
                const calcTime = performance.now() - start;
                
                frameCount++;
                totalTime += calcTime;
                
                if (ptr !== 0) {
                    const positions = new Float64Array(wasmModule.memory.buffer, ptr, wasmModule.get_coordinate_count());
                    const earthPos = [positions[12], positions[13], positions[14]];
                    const earthDist = Math.sqrt(earthPos[0]**2 + earthPos[1]**2 + earthPos[2]**2);
                    
                    dataDiv.innerHTML = `
                        <div class="success">‚úÖ Frame ${frameCount} - Calculation: ${calcTime.toFixed(3)}ms</div>
                        <div class="info">üìä Average time: ${(totalTime / frameCount).toFixed(3)}ms</div>
                        <div class="info">üåç Earth position: [${earthPos.map(v => v.toFixed(6)).join(', ')}]</div>
                        <div class="info">üìè Earth distance: ${earthDist.toFixed(6)} AU</div>
                        <div class="info">üìÖ Julian Day: ${jd.toFixed(6)}</div>
                    `;
                } else {
                    dataDiv.innerHTML = `<div class="error">‚ùå Frame ${frameCount} - Calculation failed</div>`;
                }
            }, 16); // ~60fps
        };

        // Initialize when page loads
        window.addEventListener('load', async () => {
            log('üåå Debug console loaded', 'success');
            updateModuleStatus();
            
            const success = await initWasm();
            if (success) {
                log('üéâ WASM module ready for testing!', 'success');
            } else {
                log('üí• WASM module failed to initialize', 'error');
            }
        });
    </script>
</body>
</html>